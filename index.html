<!DOCTYPE html>
<html lang="en">
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
	<script src="colorbrewer.js"></script>
	<link rel="stylesheet" href="ion.rangeSlider.min.css">
    <link rel="stylesheet" href="./style.css">
    <script src="ion.rangeSlider.min.js"></script>
    <script src="./script.js"></script>

	<style>
a {
  color: yellow;
}
a:link {
  text-decoration: none;
}
path {
	stroke: #000;
	stroke-width: 0.5px;
}

path.chord {
	stroke-width: 0.1px;
	fill-opacity: 0.8;
}

#div {
    font-size: 20px;
    	border-radius: 3px;
    	/*box-shadow: 0 0 5px #999;*/
    	padding: 40px;
    	pointer-events: 'none';
    	background-color: #fff;
    	position: absolute;
    }
</style>
</head>


<body>
	<div class="demo__body">
    <input id="demo_4" type="text" name="" value="" onChange="valitse2($(this).val())">
    </div>
    
    
    <div class="container">
<button onclick="valitse1('E')">unhappy (0-4)</button>
<button onclick="valitse1('B')">happy (8-9)</button>
<button onclick="valitse1('D')">extremely happy (10)</button>
</div>

<button class='open-walkthrough'>Instructions</button>

<div class="container">
  <button onclick="valitse3(0.05)">Font size +</button>
  <button onclick="valitse4(-0.05)">Font size -</button>
</div>






<div class='walkthrough'>
  <div class='walkthrough-pagination'>
    <a class='dot active'></a>
    <a class='dot'></a>
    <a class='dot'></a>
    <a class='dot'></a>
    <a class='dot'></a>
  </div>
  <div class='walkthrough-body'>
    <ul class='screens animate'>
      <li class='screen active'>
        <div class='media logo'>
          <img class='logo' src='https://s3.amazonaws.com/jebbles-codepen/icon.png'>
        </div>
        <h3>
          Chord diagram
          <br>walkthrough</br>
        </h3>
        <p>The European Social Survey has been collecting country-specific data at <a href="https://www.europeansocialsurvey.org">https://www.europeansocialsurvey.org</a> since 2002. The latest available data is from 2018.
 </p>
 <p>
The survey measures the attitudes, beliefs and behaviour patterns of diverse populations in more than thirty nations. </p>
      </li>
      <li class='screen'>
        <div class='media books'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/book_icon_1.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/book_icon_2.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/book_icon_3.png'>
        </div>
        <h3>
          How to investigate
          <br>happy people?</br>
        </h3>
        <p>In many comparison, Finland is mentioned as the happiest country in the world. <br>What makes people feel happy? <br>Are there any recipes for happiness? 
     </p>
        <p>
        Perhaps correlations give some glues, how happiness is related between indicators.</p>
      </li>
      <li class='screen'>
        <div class='media bars'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/bar_icon_axis.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/bar_icon_3.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/bar_icon_2.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/bar_icon_1.png'>
        </div>
        <h3>
          How to use
          <br>chord diagram?</br>
        </h3>
        <p>The chord diagram is showing relation between different indicators. All results are related only to happy people.
        </p>
        <p>
        Simple view the relations associated with an individual indicator by clicking the color wheel button next to the desired title.
        </p>
      </li>
      <li class='screen'>
        <div class='media files'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/file_icon_1.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/file_icon_2.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/file_icon_3.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/file_icon_4.png'>
        </div>
        <h3>
          How to use
          <br>sliders?</br>
        </h3>
        <p>On the top of the scree, narrow displaying negative or positive correlations only, by setting the left slider to -1 (only positive coreelations are displayed), or the right slider to 1 (only negative correlations are displayed).</p>
      </li>
      <li class='screen'>
        <div class='media comm'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/comm_icon_1.png'>
          <img class='icon' src='https://s3.amazonaws.com/jebbles-codepen/comm_icon_2.png'>
        </div>
        <h3>
          How to analyze
          <br>indicators?</br>
        </h3>
        <p>Example:
<br>1. Set the right slider to 1 
<br>2. Set the left slider to -0.4
<br>3. Click the color button next to the "Nationalist" topic
<br>4. The following indicators have negative relationships with the "Nationalist", if the probability is set over 40%.</p>
      </li>
    </ul>
    <button class='prev-screen'>
      <i class='icon-angle-left'></i>
    </button>
    <button class='next-screen'>
      <i class='icon-angle-right'></i>
    </button>
  </div>
  <div class='walkthrough-footer'>
    <button class='button next-screen'>Next</button>
    <button class='button finish close' disabled='true'>Finish</button>
  </div>
</div>
<!-- partial -->
	<div id="div" class="ext-chord"></div>
<script>
var mini = -1.0;
var maxi = 0.4;
var minval=parent.minval;
var maxval=parent.maxval;
var fitems=parent.fitems;
var scalesize=0.3;
var _data = [];
var konsoli=[];
var diagram = {
	set_dimensions: function(width, height, scale) {
		var width = width || 800,
			height = height || 800,
			outer_radius = Math.min(width, height) / 2 - 10.0,
			scale = scale || 0.5;
		
		diagram.dimensions = {
			width: width,
			height: height,
			
			outer_radius: outer_radius,
			inner_radius: outer_radius - 24.0,
			
			svg_position_x: width,
			svg_position_y: height * 0.8,
			
			scale: scale,
		};
	},
	
	opts: {
		container_class: "ext-chord",
		hw_ratio: 1.0,
		fade_out_opacity: 0.0,
		max_no_of_entities: 75,
		ignore: {
			entities: [],
			types: ["System", "Setup", "Other"]
		},
		fill: d3.scale.ordinal()
			.range([]
				.concat(colorbrewer.BrBG[11])
				.concat(colorbrewer.Pastel1[9])
				.concat(colorbrewer.Spectral[11])
				.concat(colorbrewer.Set3[12])
				.concat(colorbrewer.PuBuGn[9])
			),
		fade: function(opacity) {
			return function(g) {
				diagram.elements.svg.selectAll("g.svg-group path.chord")
					.filter(function(d) {
						return d.source.index != g.index && d.target.index != g.index;
					})
					.transition(0)
						.delay(opacity==1 ? 100 : 0)
						.style("opacity", opacity);
			};
		},
	},
	
	render: function() {
		diagram.prepare_data_and_matrix();
		diagram.elements = {};
		diagram.make_svg_element();
		diagram.make_chord_diagram();
	},
	
	prepare_data_and_matrix: function() {
		diagram.data = diagram.get_data();
		diagram.initialize_ids_and_matrix();
		diagram.assign_relationship_values_to_matrix();
	},
	
	make_svg_element: function() {
		var container = d3.select("." + diagram.opts.container_class);
		container.selectAll("svg").remove();
		var target_width = parseFloat(d3.select(container.node().parentNode).style("width")) / 1.4;
		var scale = scalesize;
		diagram.set_dimensions(target_width, diagram.opts.hw_ratio * target_width, scale)
		diagram.elements.svg = container.append("svg")
				.attr("width", diagram.dimensions.width * 2 * diagram.dimensions.scale)
				.attr("height", diagram.dimensions.height * 2 * diagram.dimensions.scale)
			
			.append("g") 
				.attr("class", "svg-group")
				.attr("transform", "translate(" 
					+ diagram.dimensions.svg_position_x * diagram.dimensions.scale + ","
					+ diagram.dimensions.svg_position_y * diagram.dimensions.scale + ")"
					+ "scale(" + diagram.dimensions.scale + ")"
				)
				
		d3.select(window).on("resize", function() {
			console.log("resized");
			diagram.render();
		});
	},
	
	make_chord_diagram: function() {
		diagram.prepare_chord_layout();
		diagram.make_arcs();
		diagram.make_chords();
	},
	
	initialize_ids_and_matrix: function() {
		diagram.entity_names = [];
		diagram.data.forEach(function(relationship) {
			if(diagram.entity_names.indexOf(relationship.source)===-1)
				diagram.entity_names.push(relationship.source);
			
			if(diagram.entity_names.indexOf(relationship.target)===-1)
				diagram.entity_names.push(relationship.target);
			
		});
		diagram.entity_names = diagram.entity_names.sort();
		diagram.entities = {};
		var n = 0;
		diagram.entity_names
			.forEach(function(entity_name) {
				diagram.entities[entity_name] = { id: n, name: entity_name };
				n++;
			});
		
		diagram.data.forEach(function(relationship) {
			relationship.source_id = diagram.entities[relationship.source].id;
			relationship.target_id = diagram.entities[relationship.target].id;
		});
		
		diagram.matrix = [];
		for(var i = 0; i < n; i++) {
			diagram.matrix[i] = [];
			for(var j = 0; j < n; j++) {
				diagram.matrix[i][j] = 0;
			}
		}
	},
	
	assign_relationship_values_to_matrix: function() {
		diagram.data.forEach(function(relationship) {
			diagram.matrix[relationship.source_id][relationship.target_id] = 1.0;
			diagram.matrix[relationship.target_id][relationship.source_id] = 0.5;
		});
	},
	
	prepare_chord_layout: function() {
		diagram.layout = d3.layout.chord()
			.padding(0.04); 
		diagram.layout.matrix(diagram.matrix);
	},
	
	make_arcs: function() {
		var arc = d3.svg.arc()
			.innerRadius(diagram.dimensions.inner_radius)
			.outerRadius(diagram.dimensions.outer_radius);
			
		diagram.elements.entity_groups = diagram.elements.svg.selectAll("g.entity-group")
				.data(diagram.layout.groups) 
			.enter().append("g") 
				.attr("class", "entity-group");
				
		diagram.elements.entity_groups.append("path")
				.attr("d", arc)
				.style("fill", function(d) { return diagram.opts.fill(d.index); })
				.on("mouseover", diagram.opts.fade(diagram.opts.fade_out_opacity))
				.on("mouseout", diagram.opts.fade(1.0))
			.append("title")
				.text(function(d) { return diagram.entity_names[d.index]; });
		
		diagram.elements.entity_groups.append("text")
			.each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
			.attr("dy", ".35em")
			.attr("text-anchor", function(d) { return d.angle > Math.PI ? "end": null; })
			.attr("transform", function(d) {
				return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
					+ "translate(" + (diagram.dimensions.outer_radius + 5) + ")"
					+ (d.angle > Math.PI ? "rotate(180)" : "")
			})
			.text(function(d) { return diagram.entity_names[d.index]; });
	},
	
	make_chords: function() {
		var chord = d3.svg.chord()
			.radius(diagram.dimensions.inner_radius);
		
		diagram.elements.svg.selectAll("path.chord")
				.data(diagram.layout.chords)
			.enter().append("path")
					.attr("class", "chord")
					.attr("d", chord)
					.style("fill", function(d) { return diagram.opts.fill(d.source.index); })
				.append("title")
					.text(function(d) {
						return diagram.entity_names[d.source.index] + " is used in "
							+ diagram.entity_names[d.target.index];
					});
	},
	
	get_data: function() {
		var entity_count = {};
		_data.forEach(function(rel) {
			if(diagram.opts.ignore.entities.indexOf(rel.source)!==-1 || diagram.opts.ignore.entities.indexOf(rel.target)!==-1)
				return;
			if(diagram.opts.ignore.types.indexOf(rel.source_type)!==-1 || diagram.opts.ignore.types.indexOf(rel.target_type)!==-1)
				return;
			if(entity_count[rel.source]===undefined)
				entity_count[rel.source] = 0.0;
			entity_count[rel.source] += 1;
			if(entity_count[rel.target]===undefined)
				entity_count[rel.target] = 0.0;
			entity_count[rel.target] += 1;
		});
		
		var valid_entities = d3.keys(entity_count).sort(function(a, b) {
			return entity_count[b] - entity_count[a];
		});
		
		var max_no_of_entities = diagram.opts.max_no_of_entities;
		var container = d3.select("." + diagram.opts.container_class);
		if(container.attr("max_no_of_entities")) {
			max_no_of_entities = parseInt(container.attr("max_no_of_entities"));
		}
		
		valid_entities.splice(max_no_of_entities+1, valid_entities.length);

		var new_data = [];
		_data.forEach(function(rel) {
			if(valid_entities.indexOf(rel.source)!==-1 && valid_entities.indexOf(rel.target)!==-1)
				new_data.push(rel);
		});
		
		return new_data;
	},
	
};


$(function () {
    $("#demo_4").ionRangeSlider({
        skin: "big",
        type: "double",
        grid: true,
        min: -1.0,
        max: 1.0,
        from: -1.0,
        to: 0.4,
        step: 0.01
        });
});


function valitse1(items) {
//fitems = filet;
//xfilet = filet;
//mini = items.substr(0,items.indexOf(";"));
//maxi = items.substr(items.indexOf(";")+1,4);
diagram.render();
valinnat([items],mini,maxi);
}

function valitse2(items) {
//fitems = filet;
//xfilet = filet;
mini = items.substr(0,items.indexOf(";"));
maxi = items.substr(items.indexOf(";")+1,4);
diagram.render();
valinnat(["D"],mini,maxi);
}

function valitse3(items) {
scalesize=scalesize+items;
div.style.fontSize = "25px";
diagram.render();

}

function valitse4(items) {
scalesize=scalesize+items;
div.style.fontSize = "35px";
diagram.render();

}


function valinnat(items, mini, maxi) {
konsoli=[];
var links =[];
var minval=mini;
var maxval=maxi;
var sitems=items;
	for ( x = 0; x < items.length; x++ ) {
	var fitems = "./"+items[x]+".json";
	//console.log(fitems);
	$.ajax({dataType: "json", url: fitems, data: links, async: false, success: function(data) {
    for ( y = 0; y < data.links.length; y++ ) {
	konsoli.push({source: data.links[y].source, target: data.links[y].target, value: data.links[y].value});
	}}});
	}
	links = konsoli.filter(function(d){return d.value < minval || d.value > maxval;});
	_data = links;
	diagram.render();
	}
	
//valinnat(fitems,minval,maxval);
valinnat(["D"],-1.0,0.4);

</script>
</body>
</html>
